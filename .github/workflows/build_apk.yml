name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # --- الخطوة الجديدة: تجهيز وطبخ React ---
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Build React App
      run: |
        # تثبيت المكتبات
        npm install
        
        # محاولة البناء باستخدام Vite مع ضبط المسارات لتكون نسبية (مهم جداً للتطبيقات Offline)
        # هذا الأمر سيحول ملفات tsx إلى html/js عادي في مجلد dist
        npx vite build --base=./ || npm run build
        
    # ---------------------------------------

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.0'
        channel: 'stable'

    - name: Create Flutter App Wrapper
      run: |
        flutter create my_app
        cd my_app
        flutter pub add webview_flutter
        
        # تفعيل الـ Assets
        sed -i 's/# assets:/assets:/' pubspec.yaml
        sed -i 's/#   - images\/a_dot_burr.jpeg/  - assets\/www\//' pubspec.yaml
        
        # تصحيح إصدار SDK للأندرويد
        sed -i 's/compileSdkVersion flutter.compileSdkVersion/compileSdkVersion 34/g' android/app/build.gradle
        
        mkdir -p assets/www
        cd ..

    - name: Move Built Files to Flutter Assets
      run: |
        # هنا التغيير: ننسخ الوجبة الجاهزة (dist) بدلاً من المكونات الخام
        # عادة في React/Vite المجلد يكون اسمه dist أو build
        if [ -d "dist" ]; then
          cp -r dist/* my_app/assets/www/
        elif [ -d "build" ]; then
          cp -r build/* my_app/assets/www/
        else
          echo "Error: Could not find build folder (dist or build)"
          exit 1
        fi

    - name: Write Main Code (Fixed Path)
      run: |
        cd my_app/lib
        cat > main.dart <<INNEREOF
        import 'package:flutter/material.dart';
        import 'package:webview_flutter/webview_flutter.dart';

        void main() {
          runApp(const MaterialApp(debugShowCheckedModeBanner: false, home: LocalWebView()));
        }

        class LocalWebView extends StatefulWidget {
          const LocalWebView({super.key});
          @override
          State<LocalWebView> createState() => _LocalWebViewState();
        }

        class _LocalWebViewState extends State<LocalWebView> {
          late final WebViewController _controller;

          @override
          void initState() {
            super.initState();
            
            _controller = WebViewController()
              ..setJavaScriptMode(JavaScriptMode.unrestricted)
              ..setBackgroundColor(const Color(0xFFFFFFFF))
              ..setNavigationDelegate(
                NavigationDelegate(
                  onWebResourceError: (WebResourceError error) {
                    debugPrint('Web Error: ${error.description}');
                  },
                ),
              );

            // تحميل ملف index.html من المجلد الذي تم بناؤه
            _controller.loadRequest(Uri.parse('file:///android_asset/flutter_assets/assets/www/index.html'));
          }

          @override
          Widget build(BuildContext context) {
            return Scaffold(
              backgroundColor: Colors.white, 
              body: SafeArea(
                child: WebViewWidget(controller: _controller),
              ),
            );
          }
        }
        INNEREOF

    - name: Build APK
      run: |
        cd my_app
        sed -i 's/<manifest xmlns:android/<manifest xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android" package="com.example.my_app">\n    <uses-permission android:name="android.permission.INTERNET"\/>/' android/app/src/main/AndroidManifest.xml
        flutter build apk --release

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-release-react-fixed
        path: my_app/build/app/outputs/flutter-apk/app-release.apk
